name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate HTML structure
        run: |
          echo "✓ Validating HTML structure..."
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "❌ Error: Missing DOCTYPE declaration"
            exit 1
          fi
          if ! grep -q "<html" index.html; then
            echo "❌ Error: Missing HTML tag"
            exit 1
          fi
          echo "✓ HTML structure is valid"

      - name: Validate CSS file
        run: |
          echo "✓ Validating CSS file..."
          if [ ! -f styles.css ]; then
            echo "❌ Error: styles.css not found"
            exit 1
          fi
          echo "✓ CSS file exists"

      - name: Validate JavaScript syntax
        run: |
          echo "✓ Validating JavaScript..."
          if [ ! -f script.js ]; then
            echo "❌ Error: script.js not found"
            exit 1
          fi
          node -c script.js && echo "✓ JavaScript syntax is valid" || exit 1

      - name: Check required files
        run: |
          echo "✓ Checking required files..."
          required_files=("index.html" "styles.css" "script.js" "vercel.json" "package.json" "README.md")
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "❌ Error: Missing required files: ${missing_files[*]}"
            exit 1
          fi
          echo "✓ All required files present"

      - name: Validate JSON files
        run: |
          echo "✓ Validating JSON files..."
          node -e "JSON.parse(require('fs').readFileSync('vercel.json'))" && echo "✓ vercel.json is valid" || exit 1
          node -e "JSON.parse(require('fs').readFileSync('package.json'))" && echo "✓ package.json is valid" || exit 1

      - name: Check file sizes
        run: |
          echo "✓ Checking file sizes..."
          html_size=$(wc -c < index.html)
          css_size=$(wc -c < styles.css)
          js_size=$(wc -c < script.js)
          echo "HTML: ${html_size} bytes"
          echo "CSS: ${css_size} bytes"
          echo "JavaScript: ${js_size} bytes"
          if [ $html_size -gt 500000 ] || [ $css_size -gt 500000 ] || [ $js_size -gt 500000 ]; then
            echo "⚠ Warning: One or more files exceed 500KB"
          fi
          echo "✓ File size check passed"

      - name: Check for broken links (basic)
        run: |
          echo "✓ Checking for broken references..."
          if grep -q "undefined" script.js; then
            echo "⚠ Warning: Found 'undefined' in script.js"
          fi
          echo "✓ Basic validation passed"

  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}
